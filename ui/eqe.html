<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EQE Measurement - PHYS 2150</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/eqe-layout.css">

    <!-- Plotly.js for interactive plots (local copy) -->
    <script src="js/plotly.min.js"></script>

    <!-- Qt WebChannel -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <!-- Shared modules -->
    <script src="js/api.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/modals.js"></script>
</head>
<body class="dark-mode eqe-body">
    <div class="eqe-app">
        <!-- Tab Navigation with Header Actions -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('measurement')">Measurement</button>
            <button class="tab-btn" onclick="switchTab('stability')">Stability Test</button>
            <button class="tab-btn staff-tab" id="analysis-tab-btn" onclick="switchTab('analysis')" style="display: none;">
                EQE Analysis
                <span class="staff-badge-small">STAFF</span>
            </button>
            <div class="tab-bar-spacer"></div>
            <span id="pixel-label" class="text-muted">Pixel: --</span>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                <svg id="sun-icon" class="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <svg id="moon-icon" class="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
        </div>

        <!-- Hidden file inputs for EQE Analysis -->
        <input type="file" id="power-file-input" accept=".csv" style="display: none;" onchange="onPowerFileSelected(event)">
        <input type="file" id="current-file-input" accept=".csv" style="display: none;" onchange="onCurrentFileSelected(event)">

        <!-- Device Status Row with Monochromator Controls (shared across tabs) -->
        <div class="device-status-row">
            <span class="row-section-title">Device Status</span>
            <div class="device-item">
                <span class="device-dot disconnected" id="picoscope-dot"></span>
                <span class="device-name">PicoScope:</span>
                <span class="device-status" id="picoscope-status">Connecting...</span>
            </div>
            <div class="device-item">
                <span class="device-dot disconnected" id="mono-dot"></span>
                <span class="device-name">Monochromator:</span>
                <span class="device-status" id="mono-status">Connecting...</span>
            </div>
            <div class="device-item">
                <span class="device-dot disconnected" id="power-dot"></span>
                <span class="device-name">Power Meter:</span>
                <span class="device-status" id="power-status">Connecting...</span>
            </div>

            <div class="mono-controls-inline">
                <span class="row-section-title">Monochromator</span>
                <span class="mono-state"><span id="mono-wavelength">--</span> nm</span>
                <span class="shutter-badge closed" id="shutter-badge">Closed</span>
                <input type="number" id="wavelength-input" placeholder="nm" min="200" max="1200">
                <button class="btn btn-secondary btn-small" onclick="goToWavelength()">Go</button>
                <button class="btn btn-secondary btn-small" id="shutter-btn" onclick="toggleShutter()">Open</button>
                <button class="btn btn-secondary btn-small" onclick="alignMonochromator()">Align</button>
            </div>
        </div>

        <!-- ==================== MEASUREMENT TAB ==================== -->
        <div id="tab-measurement" class="tab-content active">

        <!-- Top Section: Parameters + Progress -->
        <div class="top-section">
            <div class="params-panel">
                <div class="panel-title">Measurement Parameters</div>
                <div class="params-grid">
                    <div class="param-field">
                        <label>Start (nm)</label>
                        <input type="number" id="start-wavelength" value="350" step="10">
                    </div>
                    <div class="param-field">
                        <label>End (nm)</label>
                        <input type="number" id="end-wavelength" value="750" step="10">
                    </div>
                    <div class="param-field">
                        <label>Step (nm)</label>
                        <input type="number" id="step-size" value="10" step="1">
                    </div>
                    <div class="param-field">
                        <label>Cell Number</label>
                        <input type="text" id="cell-number" placeholder="e.g. 140" maxlength="3">
                    </div>
                </div>
            </div>

            <div class="progress-panel">
                <div class="panel-title">Status</div>
                <div class="progress-content">
                    <div class="progress-status" id="progress-status">Ready</div>
                    <div class="progress-bar-container" id="progress-bar-row">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <span class="progress-percent" id="progress-percent">0%</span>
                    </div>
                    <div class="live-reading hidden" id="live-reading">
                        <span id="live-value">--</span> nA
                    </div>
                </div>
            </div>
        </div>

        <!-- Three Plots Row -->
        <div class="plots-row">
            <div class="plot-panel">
                <div class="plot-title">Incident Light Power</div>
                <div class="plot-container">
                    <div id="power-plot" class="plot"></div>
                </div>
            </div>

            <div class="plot-panel">
                <div class="plot-title">PV Current</div>
                <div class="plot-container">
                    <div id="current-plot" class="plot"></div>
                </div>
                <div class="stats-row hidden" id="stats-row">
                    <span class="stat-item">n: <span class="stat-value" id="stats-n">--</span></span>
                    <span class="stat-item">CV: <span class="stat-value" id="stats-cv">--%</span></span>
                    <span class="quality-badge" id="stats-quality">--</span>
                </div>
            </div>

            <div class="plot-panel">
                <div class="plot-title">Phase Response and Sine Fit</div>
                <div class="plot-container">
                    <div id="phase-plot" class="plot"></div>
                </div>
            </div>
        </div>

        <!-- Buttons Row -->
        <div class="buttons-row">
            <button class="btn btn-primary" id="power-btn" onclick="startPowerMeasurement()">
                Start Power Measurement
            </button>
            <button class="btn btn-primary" id="current-btn" onclick="startCurrentMeasurement()">
                Start Current Measurement
            </button>
            <button class="btn btn-danger" id="stop-btn" onclick="stopMeasurement()" disabled>
                Stop
            </button>
            <button class="btn btn-secondary" id="save-btn" onclick="saveData()" disabled>
                Save Data
            </button>
            <button class="btn btn-secondary" id="live-btn" onclick="toggleLiveMonitor()">
                Live Monitor
            </button>
        </div>

        </div><!-- End Measurement Tab -->

        <!-- ==================== STABILITY TEST TAB ==================== -->
        <div id="tab-stability" class="tab-content">

        <!-- Configuration Row -->
        <div class="stability-config">
            <div class="stability-config-panel">
                <div class="config-header">
                    <div class="panel-title">Test Configuration</div>
                    <div class="test-type-selector">
                        <label>Test Type:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="stability-type" value="power" checked onchange="onStabilityTypeChange()">
                                <span>Power</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="stability-type" value="current" onchange="onStabilityTypeChange()">
                                <span>Current</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="params-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="param-field">
                        <label>Wavelength (nm)</label>
                        <input type="number" id="stability-wavelength" value="550" step="10">
                    </div>
                    <div class="param-field">
                        <label>Duration (min)</label>
                        <input type="number" id="stability-duration" value="5" min="1" max="60">
                    </div>
                    <div class="param-field">
                        <label>Interval (sec)</label>
                        <input type="number" id="stability-interval" value="2" min="1" max="60">
                    </div>
                </div>
            </div>

            <div class="progress-panel">
                <div class="panel-title">Status</div>
                <div class="progress-content">
                    <div class="progress-status" id="stability-status">Ready</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="stability-progress-fill" style="width: 0%"></div>
                        </div>
                        <span class="progress-percent" id="stability-progress-percent">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dual Plots Row -->
        <div class="stability-plots">
            <div class="plot-panel">
                <div class="plot-title">Time Series</div>
                <div class="plot-container">
                    <div id="stability-time-plot" class="plot"></div>
                </div>
            </div>
            <div class="plot-panel">
                <div class="plot-title">Histogram</div>
                <div class="plot-container">
                    <div id="stability-hist-plot" class="plot"></div>
                </div>
            </div>
        </div>

        <!-- Statistics Bar -->
        <div class="stability-stats-bar">
            <div class="stability-stat">
                <span class="stability-stat-label">Mean:</span>
                <span class="stability-stat-value" id="stability-mean">--</span>
            </div>
            <div class="stability-stat">
                <span class="stability-stat-label">Std Dev:</span>
                <span class="stability-stat-value" id="stability-std">--</span>
            </div>
            <div class="stability-stat">
                <span class="stability-stat-label">CV:</span>
                <span class="stability-stat-value cv" id="stability-cv">--%</span>
            </div>
            <div class="stability-stat">
                <span class="stability-stat-label">Count:</span>
                <span class="stability-stat-value" id="stability-count">0</span>
            </div>
            <div class="stability-stat">
                <span class="stability-stat-label">Range:</span>
                <span class="stability-stat-value" id="stability-range">--</span>
            </div>
        </div>

        <!-- Buttons Row -->
        <div class="buttons-row">
            <button class="btn btn-primary" id="stability-start-btn" onclick="startStabilityTest()">
                Start Test
            </button>
            <button class="btn btn-danger" id="stability-stop-btn" onclick="stopStabilityTest()" disabled>
                Stop Test
            </button>
            <button class="btn btn-secondary" id="stability-save-btn" onclick="saveStabilityData()" disabled>
                Save Results
            </button>
        </div>

        </div><!-- End Stability Tab -->

        <!-- EQE Analysis Tab (Staff Mode - Ctrl+Shift+E) -->
        <div id="tab-analysis" class="tab-content">
            <!-- Top Section: Data Source + Status -->
            <div class="top-section">
                <div class="params-panel analysis-source-panel">
                    <div class="panel-title">Data Source</div>
                    <div class="analysis-source-layout">
                        <div class="analysis-data-grid">
                            <span class="analysis-data-label">Power:</span>
                            <button class="btn btn-secondary btn-xs" id="use-power-session-btn" onclick="usePowerSession()" disabled>Session</button>
                            <button class="btn btn-secondary btn-xs" onclick="loadPowerCSV()">Load File</button>
                            <span class="analysis-file-status" id="power-file-status">No data</span>

                            <span class="analysis-data-label">Current:</span>
                            <button class="btn btn-secondary btn-xs" id="use-current-session-btn" onclick="useCurrentSession()" disabled>Session</button>
                            <button class="btn btn-secondary btn-xs" onclick="loadCurrentCSV()">Load File</button>
                            <span class="analysis-file-status" id="current-file-status">No data</span>
                        </div>
                        <button class="btn btn-primary" id="calculate-eqe-btn" onclick="calculateEQE()" disabled>
                            Calculate EQE
                        </button>
                    </div>
                </div>

                <div class="progress-panel">
                    <div class="panel-title">Status</div>
                    <div class="progress-content">
                        <div class="progress-status analysis-status-text" id="analysis-status">Ready - load power and current data to calculate EQE</div>
                    </div>
                </div>
            </div>

            <!-- Plot Row: EQE Spectrum + Results -->
            <div class="analysis-plots-row">
                <div class="plot-panel analysis-eqe-panel">
                    <div class="plot-title">EQE Spectrum</div>
                    <div class="plot-container">
                        <div id="eqe-plot" class="plot"></div>
                    </div>
                </div>

                <div class="params-panel analysis-results-panel">
                    <div class="panel-title">Results</div>
                    <div class="analysis-metrics">
                        <div class="analysis-metric">
                            <span class="analysis-metric-label">Peak EQE</span>
                            <span class="analysis-metric-value peak" id="metric-peak-eqe">--%</span>
                            <span class="analysis-metric-detail" id="metric-peak-wavelength">at -- nm</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="analysis-metric-label">Bandgap Edge</span>
                            <span class="analysis-metric-value" id="metric-bandgap">-- nm</span>
                            <span class="analysis-metric-detail" id="metric-bandgap-ev">(-- eV)</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="analysis-metric-label">Integrated J<sub>sc</sub></span>
                            <span class="analysis-metric-value" id="metric-jsc">-- mA/cmÂ²</span>
                            <span class="analysis-metric-detail" id="metric-jsc-note">AM1.5G spectrum</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="analysis-metric-label">Data Points</span>
                            <span class="analysis-metric-value" id="metric-datapoints">--</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="btn-save-analysis" onclick="saveAnalysisResults()" disabled>Save Results</button>
                </div>
            </div>
        </div><!-- End Analysis Tab -->

    </div>

    <!-- Cell Number Modal (shown on startup) -->
    <div class="modal-overlay" id="cell-modal">
        <div class="modal">
            <div class="modal-title">Enter Cell Number</div>
            <div class="modal-body">
                <div class="input-group mb-0">
                    <label for="cell-input">Cell Number (e.g., 195)</label>
                    <input type="text" id="cell-input" pattern="[0-9]{3}" maxlength="3" placeholder="000">
                    <span class="input-error" id="cell-input-error">Please enter a 3-digit cell number</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCellModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmCellNumber()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Pixel Selection Modal -->
    <div class="modal-overlay" id="pixel-modal">
        <div class="modal">
            <div class="modal-title">Select Pixel</div>
            <div class="modal-body">
                <div class="input-group mb-0">
                    <label for="pixel-input">Pixel Number (1-8)</label>
                    <input type="number" id="pixel-input" min="1" max="8" value="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePixelModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmPixel()">Start</button>
            </div>
        </div>
    </div>

    <!-- Save Data Modal -->
    <div class="modal-overlay" id="save-modal">
        <div class="modal">
            <div class="modal-title">Save Data</div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-secondary);">Which data would you like to save?</p>
                <div class="save-options">
                    <button class="btn btn-primary btn-block" id="save-power-btn" onclick="LabModals.confirmSavePower()" style="margin-bottom: 8px;">
                        Save Power Data
                    </button>
                    <button class="btn btn-primary btn-block" id="save-current-btn" onclick="LabModals.confirmSaveCurrent()">
                        Save Current Data
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="LabModals.closeSave()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal-overlay" id="error-modal">
        <div class="modal">
            <div class="modal-title" id="error-modal-title">Error</div>
            <div class="modal-body">
                <p id="error-modal-message" style="color: var(--text-secondary); white-space: pre-wrap; text-align: left;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="LabModals.closeError()">OK</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="modal-overlay" id="info-modal">
        <div class="modal">
            <div class="modal-title" id="info-modal-title">Info</div>
            <div class="modal-body">
                <p id="info-modal-message" style="color: var(--text-secondary); white-space: pre-line;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="LabModals.closeInfo()">OK</button>
            </div>
        </div>
    </div>

    <!-- Console Panel -->
    <div class="console-panel" id="console-panel">
        <div class="console-header">
            <div class="console-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="4 17 10 11 4 5"></polyline>
                    <line x1="12" y1="19" x2="20" y2="19"></line>
                </svg>
                Console
            </div>
            <div class="console-actions">
                <button class="console-btn" onclick="clearConsole()">Clear</button>
                <button class="console-btn" onclick="toggleConsole()">Close</button>
            </div>
        </div>
        <div class="console-output" id="console-output">
            <div class="console-empty">No log messages yet. Run a measurement to see output.</div>
        </div>
    </div>

    <!-- Application module (ES6) -->
    <script type="module" src="js/eqe-app.js"></script>
</body>
</html>
