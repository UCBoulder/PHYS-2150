<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-V Measurement - PHYS 2150</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/jv-layout.css">

    <!-- Plotly.js for interactive plots (local copy) -->
    <script src="js/plotly.min.js"></script>

    <!-- Qt WebChannel -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <!-- Shared modules -->
    <script src="js/api.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/modals.js"></script>
</head>
<body class="dark-mode jv-body">
    <div class="jv-app">
        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('measurement')">Measurement</button>
            <button class="tab-btn staff-tab" id="analysis-tab-btn"
                    onclick="switchTab('analysis')" style="display: none;">
                I-V Analysis
                <span class="staff-badge-small">STAFF</span>
            </button>
            <div class="tab-bar-spacer"></div>
            <span id="pixel-label" class="text-muted">Pixel: --</span>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                <svg id="sun-icon" class="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <svg id="moon-icon" class="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
        </div>

        <!-- ============================================
             MEASUREMENT TAB
             ============================================ -->
        <div id="tab-measurement" class="tab-content active">
            <!-- Device Status Row -->
            <div class="device-status-row">
                <span class="row-section-title">Device Status</span>
                <div class="device-item">
                    <span class="device-dot disconnected" id="status-dot"></span>
                    <span class="device-name">Keithley 2450:</span>
                    <span class="device-status" id="status-text">Connecting...</span>
                </div>
            </div>

            <!-- Parameters + Status Row -->
            <div class="top-section">
                <div class="params-panel">
                    <div class="panel-title">Measurement Parameters</div>
                    <div class="params-grid">
                        <div class="param-field">
                            <label for="start-voltage">Start (V)</label>
                            <input type="text" id="start-voltage" value="-0.1" autocomplete="off">
                        </div>
                        <div class="param-field">
                            <label for="stop-voltage">Stop (V)</label>
                            <input type="text" id="stop-voltage" value="0.7" autocomplete="off">
                        </div>
                        <div class="param-field">
                            <label for="step-voltage">Step (V)</label>
                            <input type="text" id="step-voltage" value="0.02" autocomplete="off">
                        </div>
                        <div class="param-field">
                            <label for="cell-number">Cell Number</label>
                            <input type="text" id="cell-number" placeholder="e.g. 140" maxlength="3">
                        </div>
                    </div>
                </div>
                <div class="progress-panel">
                    <div class="panel-title">Status</div>
                    <div class="progress-content">
                        <div class="progress-status" id="status-message">Ready</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar">
                                <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
                            </div>
                            <span class="progress-percent" id="progress-percent">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Plot Panel -->
            <div class="plot-panel">
                <div class="plot-container">
                    <div id="jv-plot" class="plot"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="buttons-row">
                <button class="btn btn-primary" id="measure-btn" onclick="toggleMeasurement()">
                    Start Measurement
                </button>
                <button class="btn btn-secondary" id="save-btn" onclick="saveData()" disabled>
                    Save Data
                </button>
            </div>
        </div>

        <!-- ============================================
             ANALYSIS TAB (Staff Mode)
             ============================================ -->
        <div id="tab-analysis" class="tab-content">
            <!-- Compact Data Source Row -->
            <div class="params-panel" style="padding: 10px 16px; flex: none;">
                <div class="analysis-source-row">
                    <span class="panel-title" style="margin-bottom: 0;">Data</span>

                    <button class="btn btn-secondary btn-xs" id="use-session-btn"
                            onclick="useSessionData()" disabled>Use Session</button>
                    <button class="btn btn-secondary btn-xs" onclick="loadCSVFile()">Load File</button>
                    <span class="analysis-file-status" id="data-file-status"></span>

                    <div class="analysis-separator"></div>

                    <!-- Sweep selection -->
                    <span class="analysis-data-label">Analyze:</span>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="sweep-select" value="forward" checked>
                            <span>Fwd</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="sweep-select" value="reverse">
                            <span>Rev</span>
                        </label>
                    </div>

                    <div class="analysis-separator"></div>

                    <!-- Cell area -->
                    <div class="area-input-group">
                        <label for="cell-area">Area:</label>
                        <input type="text" id="cell-area" placeholder="opt.">
                        <span class="unit">cm²</span>
                    </div>

                    <button class="btn btn-primary btn-xs" id="calculate-params-btn"
                            onclick="calculateParameters()" disabled>
                        Calculate
                    </button>

                    <span class="analysis-status-text" id="analysis-status" style="font-size: 11px; margin-left: 8px;"></span>
                </div>
            </div>

            <!-- Plot + Results Section -->
            <div class="analysis-plots-row">
                <div class="plot-panel analysis-iv-panel">
                    <div class="plot-title">I-V Curve</div>
                    <div class="plot-container">
                        <div id="iv-analysis-plot" class="plot"></div>
                    </div>
                </div>

                <div class="params-panel analysis-results-panel">
                    <div class="panel-title">Results</div>
                    <div class="analysis-metrics">
                        <!-- Headline metric: PCE -->
                        <div class="analysis-metric" id="pce-metric-group" style="display: none;">
                            <span class="analysis-metric-label">Power Conversion Efficiency</span>
                            <span class="analysis-metric-value headline" id="metric-pce">-- %</span>
                        </div>

                        <!-- Key parameters with subscripts -->
                        <div class="analysis-metric" id="jsc-metric-group">
                            <span class="analysis-metric-label">J<sub>sc</sub> (Current Density)</span>
                            <span class="analysis-metric-value primary" id="metric-jsc">-- mA/cm²</span>
                        </div>
                        <div class="analysis-metric" id="isc-metric-group" style="display: none;">
                            <span class="analysis-metric-label">I<sub>sc</sub></span>
                            <span class="analysis-metric-value secondary" id="metric-isc">-- mA</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="analysis-metric-label">V<sub>oc</sub> (Open Circuit)</span>
                            <span class="analysis-metric-value primary" id="metric-voc">-- V</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="analysis-metric-label">Fill Factor</span>
                            <span class="analysis-metric-value" id="metric-ff">-- %</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="analysis-metric-label">P<sub>max</sub></span>
                            <span class="analysis-metric-value secondary" id="metric-pmax">-- mW</span>
                        </div>

                        <!-- Secondary metrics (compact) -->
                        <div class="analysis-metrics-compact">
                            <div class="analysis-metric">
                                <span class="analysis-metric-label">V<sub>mpp</sub></span>
                                <span class="analysis-metric-value secondary" id="metric-vmpp">-- V</span>
                            </div>
                            <div class="analysis-metric">
                                <span class="analysis-metric-label">I<sub>mpp</sub></span>
                                <span class="analysis-metric-value secondary" id="metric-impp">-- mA</span>
                            </div>
                            <div class="analysis-metric">
                                <span class="analysis-metric-label">R<sub>s</sub></span>
                                <span class="analysis-metric-value secondary" id="metric-rs">-- Ω</span>
                            </div>
                            <div class="analysis-metric">
                                <span class="analysis-metric-label">R<sub>sh</sub></span>
                                <span class="analysis-metric-value secondary" id="metric-rsh">-- Ω</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="btn-save-analysis"
                            onclick="saveAnalysisResults()" disabled>Save Results</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for CSV loading -->
    <input type="file" id="csv-file-input" accept=".csv" style="display: none"
           onchange="onCSVFileSelected(event)">

    <!-- Cell Number Modal -->
    <div class="modal-overlay" id="cell-modal">
        <div class="modal">
            <div class="modal-title">Enter Cell Number</div>
            <div class="modal-body">
                <div class="input-group mb-0">
                    <label for="cell-input">Cell Number (e.g., 195)</label>
                    <input type="text" id="cell-input" pattern="[0-9]{3}" maxlength="3" placeholder="000">
                    <span class="input-error" id="cell-input-error">Please enter a 3-digit cell number</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCellModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmCellNumber()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Pixel Selection Modal -->
    <div class="modal-overlay" id="pixel-modal">
        <div class="modal">
            <div class="modal-title">Select Pixel</div>
            <div class="modal-body">
                <div class="input-group mb-0">
                    <label for="pixel-input">Pixel Number (1-9)</label>
                    <input type="number" id="pixel-input" min="1" max="9" value="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePixelModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmPixel()">Start</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal-overlay" id="error-modal">
        <div class="modal">
            <div class="modal-title" id="error-modal-title">Error</div>
            <div class="modal-body">
                <p id="error-modal-message" style="color: var(--text-secondary); white-space: pre-wrap; text-align: left;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="LabModals.closeError()">OK</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="modal-overlay" id="info-modal">
        <div class="modal">
            <div class="modal-title" id="info-modal-title">Info</div>
            <div class="modal-body">
                <p id="info-modal-message" style="color: var(--text-secondary); white-space: pre-line;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="LabModals.closeInfo()">OK</button>
            </div>
        </div>
    </div>

    <!-- Console Panel -->
    <div class="console-panel" id="console-panel">
        <div class="console-header">
            <div class="console-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="4 17 10 11 4 5"></polyline>
                    <line x1="12" y1="19" x2="20" y2="19"></line>
                </svg>
                Console
            </div>
            <div class="console-actions">
                <button class="console-btn" onclick="clearConsole()">Clear</button>
                <button class="console-btn" onclick="toggleConsole()">Close</button>
            </div>
        </div>
        <div class="console-output" id="console-output">
            <div class="console-empty">No log messages yet. Run a measurement to see output.</div>
        </div>
    </div>

    <!-- Application module (ES6) -->
    <script type="module" src="js/jv-app.js"></script>
</body>
</html>
