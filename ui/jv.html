<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-V Measurement - PHYS 2150</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/jv-layout.css">

    <!-- Plotly.js for interactive plots (local copy) -->
    <script src="js/plotly.min.js"></script>

    <!-- Qt WebChannel -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <!-- Shared modules -->
    <script src="js/api.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/modals.js"></script>
</head>
<body class="dark-mode jv-body">
    <div class="jv-app">
        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('measurement')">Measurement</button>
            <button class="tab-btn staff-tab" id="analysis-tab-btn"
                    onclick="switchTab('analysis')" style="display: none;">
                I-V Analysis
                <span class="staff-badge-small">STAFF</span>
            </button>
            <div class="tab-bar-spacer"></div>
            <span id="pixel-label" class="text-muted">Pixel: --</span>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                <svg id="sun-icon" class="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <svg id="moon-icon" class="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
        </div>

        <!-- ============================================
             MEASUREMENT TAB
             ============================================ -->
        <div id="tab-measurement" class="tab-content active">
            <!-- Device Status Row -->
            <div class="device-status-row">
                <span class="row-section-title">Device Status</span>
                <div class="device-item">
                    <span class="device-dot disconnected" id="status-dot"></span>
                    <span class="device-name">Keithley 2450:</span>
                    <span class="device-status" id="status-text">Connecting...</span>
                </div>
            </div>

            <!-- Parameters + Status Row -->
            <div class="top-section">
                <div class="params-panel">
                    <div class="panel-title">Measurement Parameters</div>
                    <div class="params-grid">
                        <div class="param-field">
                            <label for="start-voltage">Start (V)</label>
                            <input type="text" id="start-voltage" value="-0.1" autocomplete="off">
                        </div>
                        <div class="param-field">
                            <label for="stop-voltage">Stop (V)</label>
                            <input type="text" id="stop-voltage" value="0.7" autocomplete="off">
                        </div>
                        <div class="param-field">
                            <label for="step-voltage">Step (V)</label>
                            <input type="text" id="step-voltage" value="0.02" autocomplete="off">
                        </div>
                        <div class="param-field">
                            <label for="cell-number">Cell Number</label>
                            <input type="text" id="cell-number" placeholder="e.g. 140" maxlength="3">
                        </div>
                    </div>
                </div>
                <div class="progress-panel">
                    <div class="panel-title">Status</div>
                    <div class="progress-content">
                        <div class="progress-status" id="status-message">Ready</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar">
                                <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
                            </div>
                            <span class="progress-percent" id="progress-percent">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Plot Panel -->
            <div class="plot-panel">
                <div class="plot-container">
                    <div id="jv-plot" class="plot"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="buttons-row">
                <button class="btn btn-primary" id="measure-btn" onclick="toggleMeasurement()">
                    Start Measurement
                </button>
                <button class="btn btn-secondary" id="save-btn" onclick="saveData()" disabled>
                    Save Data
                </button>
            </div>
        </div>

        <!-- ============================================
             ANALYSIS TAB (Staff Mode)
             ============================================ -->
        <div id="tab-analysis" class="tab-content">
            <!-- Compact Data Source Row -->
            <div class="params-panel" style="padding: 10px 16px; flex: none;">
                <div class="analysis-source-row">
                    <span class="panel-title" style="margin-bottom: 0;">Data</span>

                    <button class="btn btn-secondary btn-xs" id="use-session-btn"
                            onclick="useSessionData()" disabled>Use Session</button>
                    <button class="btn btn-secondary btn-xs" onclick="loadCSVFile()">Load File</button>
                    <span class="analysis-file-status" id="data-file-status"></span>

                    <div class="analysis-separator"></div>

                    <!-- Sweep selection -->
                    <span class="analysis-data-label">Analyze:</span>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="sweep-select" value="forward" checked>
                            <span>Fwd</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="sweep-select" value="reverse">
                            <span>Rev</span>
                        </label>
                    </div>

                    <div class="analysis-separator"></div>

                    <!-- Cell area -->
                    <div class="area-input-group">
                        <label for="cell-area">Area:</label>
                        <input type="text" id="cell-area" placeholder="opt.">
                        <span class="unit">cm²</span>
                    </div>

                    <button class="btn btn-primary btn-xs" id="calculate-params-btn"
                            onclick="calculateParameters()" disabled>
                        Calculate
                    </button>

                    <span class="analysis-status-text" id="analysis-status" style="font-size: 11px; margin-left: 8px;"></span>
                </div>
            </div>

            <!-- Plot + Results Section -->
            <div class="analysis-plots-row">
                <div class="plot-panel analysis-iv-panel">
                    <div class="plot-title">I-V Curve</div>
                    <div class="plot-container">
                        <div id="iv-analysis-plot" class="plot"></div>
                    </div>
                </div>

                <div class="params-panel analysis-results-panel">
                    <div class="panel-title">Results</div>
                    <div class="analysis-metrics">
                        <!-- Headline metric: PCE -->
                        <div class="analysis-metric" id="pce-metric-group" style="display: none;">
                            <span class="analysis-metric-label">Power Conversion Efficiency</span>
                            <span class="analysis-metric-value headline" id="metric-pce">-- %</span>
                        </div>

                        <!-- Key parameters with subscripts -->
                        <div class="analysis-metric" id="jsc-metric-group">
                            <span class="analysis-metric-label">J<sub>sc</sub> (Current Density)</span>
                            <span class="analysis-metric-value primary" id="metric-jsc">-- mA/cm²</span>
                        </div>
                        <div class="analysis-metric" id="isc-metric-group" style="display: none;">
                            <span class="analysis-metric-label">I<sub>sc</sub></span>
                            <span class="analysis-metric-value secondary" id="metric-isc">-- mA</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="analysis-metric-label">V<sub>oc</sub> (Open Circuit)</span>
                            <span class="analysis-metric-value primary" id="metric-voc">-- V</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="analysis-metric-label">Fill Factor</span>
                            <span class="analysis-metric-value" id="metric-ff">-- %</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="analysis-metric-label">P<sub>max</sub></span>
                            <span class="analysis-metric-value secondary" id="metric-pmax">-- mW</span>
                        </div>

                        <!-- Secondary metrics (compact) -->
                        <div class="analysis-metrics-compact">
                            <div class="analysis-metric">
                                <span class="analysis-metric-label">V<sub>mpp</sub></span>
                                <span class="analysis-metric-value secondary" id="metric-vmpp">-- V</span>
                            </div>
                            <div class="analysis-metric">
                                <span class="analysis-metric-label">I<sub>mpp</sub></span>
                                <span class="analysis-metric-value secondary" id="metric-impp">-- mA</span>
                            </div>
                            <div class="analysis-metric">
                                <span class="analysis-metric-label">R<sub>s</sub></span>
                                <span class="analysis-metric-value secondary" id="metric-rs">-- Ω</span>
                            </div>
                            <div class="analysis-metric">
                                <span class="analysis-metric-label">R<sub>sh</sub></span>
                                <span class="analysis-metric-value secondary" id="metric-rsh">-- Ω</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="btn-save-analysis"
                            onclick="saveAnalysisResults()" disabled>Save Results</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for CSV loading -->
    <input type="file" id="csv-file-input" accept=".csv" style="display: none"
           onchange="onCSVFileSelected(event)">

    <!-- Cell Number Modal -->
    <div class="modal-overlay" id="cell-modal">
        <div class="modal">
            <div class="modal-title">Enter Cell Number</div>
            <div class="modal-body">
                <div class="input-group mb-0">
                    <label for="cell-input">Cell Number (e.g., 195)</label>
                    <input type="text" id="cell-input" pattern="[0-9]{3}" maxlength="3" placeholder="000">
                    <span class="input-error" id="cell-input-error">Please enter a 3-digit cell number</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCellModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmCellNumber()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Pixel Selection Modal -->
    <div class="modal-overlay" id="pixel-modal">
        <div class="modal">
            <div class="modal-title">Select Pixel</div>
            <div class="modal-body">
                <div class="input-group mb-0">
                    <label for="pixel-input">Pixel Number (1-9)</label>
                    <input type="number" id="pixel-input" min="1" max="9" value="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePixelModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmPixel()">Start</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal-overlay" id="error-modal">
        <div class="modal">
            <div class="modal-title" id="error-modal-title">Error</div>
            <div class="modal-body">
                <p id="error-modal-message" style="color: var(--text-secondary); white-space: pre-wrap; text-align: left;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="LabModals.closeError()">OK</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="modal-overlay" id="info-modal">
        <div class="modal">
            <div class="modal-title" id="info-modal-title">Info</div>
            <div class="modal-body">
                <p id="info-modal-message" style="color: var(--text-secondary); white-space: pre-line;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="LabModals.closeInfo()">OK</button>
            </div>
        </div>
    </div>

    <!-- Console Panel -->
    <div class="console-panel" id="console-panel">
        <div class="console-header">
            <div class="console-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="4 17 10 11 4 5"></polyline>
                    <line x1="12" y1="19" x2="20" y2="19"></line>
                </svg>
                Console
            </div>
            <div class="console-actions">
                <button class="console-btn" onclick="clearConsole()">Clear</button>
                <button class="console-btn" onclick="toggleConsole()">Close</button>
            </div>
        </div>
        <div class="console-output" id="console-output">
            <div class="console-empty">No log messages yet. Run a measurement to see output.</div>
        </div>
    </div>

    <script>
        /**
         * I-V Measurement Application
         */

        // ============================================
        // State
        // ============================================

        let isMeasuring = false;
        let currentPixel = null;
        let forwardData = { x: [], y: [] };
        let reverseData = { x: [], y: [] };
        let isOfflineMode = false;
        let isDeviceConnected = false;
        let activeTab = 'measurement';

        // Analysis state
        const analysisState = {
            visible: false,
            forwardData: null,  // { voltages: [], currents: [] }
            reverseData: null,
            metrics: null,
            cellNumber: null,
            pixel: null,
            sourceFile: null
        };

        // Extract cell and pixel numbers from filename
        function extractCellPixelFromFilename(filename) {
            const cellMatch = filename.match(/cell(\d+)/i);
            const pixelMatch = filename.match(/pixel(\d+)/i);
            return {
                cell: cellMatch ? cellMatch[1] : null,
                pixel: pixelMatch ? parseInt(pixelMatch[1]) : null
            };
        }

        // ============================================
        // Initialization
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            LabTheme.init();
            LabModals.init();
            await LabAPI.init();

            // Small delay to ensure Plotly is ready
            setTimeout(() => {
                initPlot();
                checkDeviceStatus();

                // Prompt for cell number on startup
                LabModals.showCell((cellNumber) => {
                    document.getElementById('cell-number').value = cellNumber;
                });
            }, 50);
        });

        // ============================================
        // Tab Navigation
        // ============================================

        function switchTab(tabName) {
            // Prevent switching during active measurements
            if (isMeasuring) {
                LabModals.showError('Cannot Switch', 'Please stop the current measurement before switching tabs.');
                return;
            }

            activeTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const btnTab = btn.getAttribute('onclick')?.match(/switchTab\('(\w+)'\)/)?.[1];
                btn.classList.toggle('active', btnTab === tabName);
            });

            // Update tab content visibility
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === 'tab-' + tabName);
            });

            // Initialize plots for the new tab
            if (tabName === 'analysis') {
                setTimeout(() => {
                    const plotDiv = document.getElementById('iv-analysis-plot');
                    if (!plotDiv.data) {
                        initAnalysisPlot();
                    } else {
                        Plotly.Plots.resize('iv-analysis-plot');
                    }
                    updateSessionButton();
                }, 50);
            } else {
                setTimeout(() => {
                    Plotly.Plots.resize('jv-plot');
                }, 50);
            }
        }

        function toggleAnalysisPanel() {
            analysisState.visible = !analysisState.visible;
            const tabBtn = document.getElementById('analysis-tab-btn');

            if (analysisState.visible) {
                tabBtn.style.display = '';
                switchTab('analysis');
            } else {
                tabBtn.style.display = 'none';
                switchTab('measurement');
            }
        }

        // ============================================
        // Measurement Tab Functions
        // ============================================

        function initPlot() {
            clearPlot();
        }

        window.addEventListener('resize', () => {
            if (typeof Plotly !== 'undefined') {
                if (activeTab === 'measurement') {
                    Plotly.Plots.resize('jv-plot');
                } else if (activeTab === 'analysis') {
                    Plotly.Plots.resize('iv-analysis-plot');
                }
            }
        });

        window.addEventListener('themechange', (e) => {
            const plotDiv = document.getElementById('jv-plot');
            if (typeof Plotly !== 'undefined' && plotDiv && plotDiv.data) {
                updatePlotTheme('jv-plot', e.detail.dark);
            }
            const analysisPlot = document.getElementById('iv-analysis-plot');
            if (typeof Plotly !== 'undefined' && analysisPlot && analysisPlot.data) {
                updatePlotTheme('iv-analysis-plot', e.detail.dark);
            }
        });

        function getPlotLayout(isDark) {
            const colors = {
                text: isDark ? '#eeeeee' : '#1a1a1a',
                grid: isDark ? '#444444' : '#dddddd',
                zeroline: isDark ? '#666666' : '#999999',
                legendBg: isDark ? 'rgba(50,50,50,0.9)' : 'rgba(255,255,255,0.9)'
            };
            return {
                xaxis: {
                    title: 'Voltage (V)',
                    color: colors.text,
                    gridcolor: colors.grid,
                    zerolinecolor: colors.zeroline,
                    zerolinewidth: 1
                },
                yaxis: {
                    title: 'Current (mA)',
                    color: colors.text,
                    gridcolor: colors.grid,
                    zerolinecolor: colors.zeroline,
                    zerolinewidth: 1
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: colors.text },
                legend: {
                    font: { color: colors.text },
                    bgcolor: colors.legendBg,
                    x: 0.02,
                    y: 0.98,
                    xanchor: 'left',
                    yanchor: 'top'
                },
                margin: { t: 20, r: 30, b: 60, l: 60 }
            };
        }

        const plotConfig = {
            displayModeBar: true,
            modeBarButtonsToRemove: ['lasso2d', 'select2d', 'toImage'],
            displaylogo: false
        };

        function updatePlotTheme(plotId, isDark) {
            const colors = {
                text: isDark ? '#eeeeee' : '#1a1a1a',
                grid: isDark ? '#444444' : '#dddddd',
                zeroline: isDark ? '#666666' : '#999999',
                legendBg: isDark ? 'rgba(50,50,50,0.9)' : 'rgba(255,255,255,0.9)'
            };
            Plotly.relayout(plotId, {
                'xaxis.color': colors.text,
                'xaxis.gridcolor': colors.grid,
                'xaxis.zerolinecolor': colors.zeroline,
                'yaxis.color': colors.text,
                'yaxis.gridcolor': colors.grid,
                'yaxis.zerolinecolor': colors.zeroline,
                'font.color': colors.text,
                'legend.font.color': colors.text,
                'legend.bgcolor': colors.legendBg
            });
        }

        async function checkDeviceStatus() {
            try {
                const api = LabAPI.get();
                if (api && api.get_device_status) {
                    api.get_device_status((result) => {
                        const status = JSON.parse(result);
                        isOfflineMode = status.offline_mode;
                        isDeviceConnected = status.connected;
                        updateDeviceStatus(status.connected, status.message, status.offline_mode);
                    });
                } else {
                    isOfflineMode = true;
                    isDeviceConnected = false;
                    updateDeviceStatus(false, 'Development mode', true);
                }
            } catch (error) {
                updateDeviceStatus(false, 'Connection failed', false);
            }
        }

        function updateDeviceStatus(connected, message, offlineMode) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const btn = document.getElementById('measure-btn');

            isDeviceConnected = connected;
            isOfflineMode = offlineMode;

            if (connected) {
                dot.className = 'device-dot connected';
                text.textContent = message || 'Connected';
                btn.disabled = false;
            } else if (offlineMode) {
                dot.className = 'device-dot warning';
                text.textContent = message || 'Offline mode';
                btn.disabled = false;
            } else {
                dot.className = 'device-dot disconnected';
                text.textContent = message || 'Not connected';
                btn.disabled = true;
            }
        }

        function toggleMeasurement() {
            if (isMeasuring) {
                stopMeasurement();
            } else {
                const cellNumber = document.getElementById('cell-number').value;
                if (!cellNumber || !/^\d{3}$/.test(cellNumber)) {
                    LabModals.showCell((cell) => {
                        document.getElementById('cell-number').value = cell;
                        LabModals.showPixel(startMeasurement);
                    });
                    return;
                }
                LabModals.showPixel(startMeasurement);
            }
        }

        async function startMeasurement(pixel) {
            currentPixel = pixel;
            isMeasuring = true;
            updateMeasuringState(true);
            updateProgress(0, 'Starting forward sweep...');

            forwardData = { x: [], y: [] };
            reverseData = { x: [], y: [] };
            document.getElementById('save-btn').disabled = true;
            clearPlot();
            updatePixelLabel(pixel);

            const params = {
                start_voltage: parseFloat(document.getElementById('start-voltage').value),
                stop_voltage: parseFloat(document.getElementById('stop-voltage').value),
                step_voltage: parseFloat(document.getElementById('step-voltage').value),
                cell_number: document.getElementById('cell-number').value,
                pixel: pixel
            };

            if (isDeviceConnected) {
                console.log('Starting hardware measurement with params:', params);
                const api = LabAPI.get();
                if (api && api.start_measurement) {
                    api.start_measurement(JSON.stringify(params), (result) => {
                        const response = JSON.parse(result);
                        if (!response.success) {
                            LabModals.showError('Measurement Failed', response.message);
                            isMeasuring = false;
                            updateMeasuringState(false);
                        }
                    });
                }
            } else if (isOfflineMode) {
                console.log('Starting mock measurement with params:', params);
                mockMeasurement(params);
            } else {
                LabModals.showError('No Device', 'No device connected. Use --offline flag for testing.');
                isMeasuring = false;
                updateMeasuringState(false);
            }
        }

        function stopMeasurement() {
            isMeasuring = false;
            updateMeasuringState(false);
            updateProgress(0, 'Stopped');

            const api = LabAPI.get();
            if (api && api.stop_measurement) {
                api.stop_measurement(() => {});
            }
        }

        function updateMeasuringState(measuring) {
            const btn = document.getElementById('measure-btn');
            const inputs = document.querySelectorAll('#tab-measurement .params-panel input');

            if (measuring) {
                btn.textContent = 'Stop Measurement';
                btn.className = 'btn btn-danger';
                inputs.forEach(input => input.disabled = true);
            } else {
                btn.textContent = 'Start Measurement';
                btn.className = 'btn btn-primary';
                inputs.forEach(input => input.disabled = false);
            }
        }

        function updateProgress(percent, message) {
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-percent').textContent = Math.round(percent) + '%';
            if (message) {
                document.getElementById('status-message').textContent = message;
            }
        }

        function updatePixelLabel(pixel) {
            document.getElementById('pixel-label').textContent = `Pixel: ${pixel}`;
        }

        // Called from Python via WebChannel
        function onMeasurementPoint(direction, voltage, current) {
            if (direction === 'forward') {
                forwardData.x.push(voltage);
                forwardData.y.push(current);
            } else {
                reverseData.x.push(voltage);
                reverseData.y.push(current);
            }
            updatePlot();
        }

        function onMeasurementComplete(success) {
            isMeasuring = false;
            updateMeasuringState(false);

            if (success) {
                updateProgress(100, 'Complete');
                document.getElementById('save-btn').disabled = false;
                console.log('Measurement complete');
                saveData();
            } else {
                updateProgress(0, 'Failed');
            }
        }

        function saveData() {
            const cellNumber = document.getElementById('cell-number').value || '000';
            const pixel = currentPixel || 1;

            let csv = 'Direction,Voltage (V),Current (mA)\n';

            for (let i = 0; i < forwardData.x.length; i++) {
                csv += `Forward,${forwardData.x[i].toFixed(4)},${forwardData.y[i].toFixed(6)}\n`;
            }

            for (let i = 0; i < reverseData.x.length; i++) {
                csv += `Reverse,${reverseData.x[i].toFixed(4)},${reverseData.y[i].toFixed(6)}\n`;
            }

            const api = LabAPI.get();
            if (api && api.save_csv_data) {
                api.save_csv_data(csv, cellNumber, pixel, (result) => {
                    const response = JSON.parse(result);
                    if (response.success) {
                        console.log('Data saved to:', response.path);
                    } else if (response.message !== 'Cancelled') {
                        LabModals.showError('Save Failed', response.message);
                    }
                });
            } else {
                console.error('Save API not available');
            }
        }

        function clearPlot() {
            const plotDiv = document.getElementById('jv-plot');
            const layout = getPlotLayout(LabTheme.isDark());
            const traces = [
                { x: [], y: [], mode: 'markers', type: 'scatter', name: 'Forward', marker: { color: '#4A90D9', size: 8 } },
                { x: [], y: [], mode: 'markers', type: 'scatter', name: 'Reverse', marker: { color: '#e57373', size: 8 } }
            ];
            Plotly.newPlot(plotDiv, traces, layout, plotConfig);
        }

        function updatePlot() {
            const plotDiv = document.getElementById('jv-plot');
            const layout = getPlotLayout(LabTheme.isDark());
            const traces = [
                { x: forwardData.x, y: forwardData.y, mode: 'markers', type: 'scatter', name: 'Forward', marker: { color: '#4A90D9', size: 8 } },
                { x: reverseData.x, y: reverseData.y, mode: 'markers', type: 'scatter', name: 'Reverse', marker: { color: '#e57373', size: 8 } }
            ];
            Plotly.newPlot(plotDiv, traces, layout, plotConfig);
        }

        // Mock measurement for offline mode
        function mockMeasurement(params) {
            const start = params.start_voltage;
            const stop = params.stop_voltage;
            const step = params.step_voltage;
            const totalSteps = Math.ceil((stop - start) / step);
            let stepCount = 0;

            let voltage = start;
            const interval = setInterval(() => {
                if (!isMeasuring || voltage > stop) {
                    clearInterval(interval);
                    if (isMeasuring) {
                        updateProgress(50, 'Reverse sweep...');
                        mockReverseSweep(stop, start, step, totalSteps);
                    }
                    return;
                }

                const current = 0.01 * (Math.exp(voltage / 0.026) - 1) + (Math.random() - 0.5) * 0.001;
                onMeasurementPoint('forward', voltage, current * 1000);
                stepCount++;
                const progress = (stepCount / totalSteps) * 50;
                updateProgress(progress, `Forward: ${voltage.toFixed(2)} V`);
                voltage += step;
            }, 50);
        }

        function mockReverseSweep(start, stop, step, totalSteps) {
            let stepCount = 0;
            let voltage = start;
            const interval = setInterval(() => {
                if (!isMeasuring || voltage < stop) {
                    clearInterval(interval);
                    onMeasurementComplete(true);
                    return;
                }

                const current = 0.01 * (Math.exp(voltage / 0.026) - 1) + (Math.random() - 0.5) * 0.001;
                onMeasurementPoint('reverse', voltage, current * 1000);
                stepCount++;
                const progress = 50 + (stepCount / totalSteps) * 50;
                updateProgress(progress, `Reverse: ${voltage.toFixed(2)} V`);
                voltage -= step;
            }, 50);
        }

        function onMeasurementProgress(percent, message) {
            updateProgress(percent, message);
        }

        // ============================================
        // Analysis Tab Functions
        // ============================================

        function initAnalysisPlot() {
            const plotDiv = document.getElementById('iv-analysis-plot');
            const layout = getPlotLayout(LabTheme.isDark());
            const traces = [
                { x: [], y: [], mode: 'lines+markers', type: 'scatter', name: 'Forward', line: { color: '#4A90D9' }, marker: { size: 6 } },
                { x: [], y: [], mode: 'lines+markers', type: 'scatter', name: 'Reverse', line: { color: '#e57373' }, marker: { size: 6 } },
                { x: [], y: [], mode: 'markers', type: 'scatter', name: 'Voc', marker: { color: '#00C853', size: 12, symbol: 'diamond' } },
                { x: [], y: [], mode: 'markers', type: 'scatter', name: 'Isc', marker: { color: '#FF6D00', size: 12, symbol: 'diamond' } },
                { x: [], y: [], mode: 'markers', type: 'scatter', name: 'MPP', marker: { color: '#AA00FF', size: 14, symbol: 'star' } }
            ];
            Plotly.newPlot(plotDiv, traces, layout, plotConfig);
        }

        function updateSessionButton() {
            const btn = document.getElementById('use-session-btn');
            btn.disabled = forwardData.x.length === 0 && reverseData.x.length === 0;
        }

        function useSessionData() {
            if (forwardData.x.length === 0 && reverseData.x.length === 0) {
                setAnalysisStatus('No session data', 'error');
                return;
            }

            if (forwardData.x.length > 0) {
                analysisState.forwardData = {
                    voltages: [...forwardData.x],
                    currents: [...forwardData.y]
                };
            }
            if (reverseData.x.length > 0) {
                analysisState.reverseData = {
                    voltages: [...reverseData.x],
                    currents: [...reverseData.y]
                };
            }

            // Get cell/pixel from measurement tab
            analysisState.cellNumber = document.getElementById('cell-number').value || null;
            analysisState.pixel = currentPixel;
            analysisState.sourceFile = 'Session';

            const fwdPts = forwardData.x.length;
            const revPts = reverseData.x.length;
            const statusEl = document.getElementById('data-file-status');
            statusEl.textContent = `Session (${fwdPts}/${revPts} pts)`;
            statusEl.classList.add('loaded');
            updateCalculateButton();
            setAnalysisStatus('Session data loaded', 'success');
        }

        function loadCSVFile() {
            const input = document.getElementById('csv-file-input');
            input.value = '';
            input.click();
        }

        function onCSVFileSelected(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const result = parseIVCSV(e.target.result);
                    analysisState.forwardData = result.forward;
                    analysisState.reverseData = result.reverse;

                    // Extract cell/pixel from filename
                    const extracted = extractCellPixelFromFilename(file.name);
                    analysisState.cellNumber = extracted.cell;
                    analysisState.pixel = extracted.pixel;
                    analysisState.sourceFile = file.name;

                    const fwdPts = result.forward ? result.forward.voltages.length : 0;
                    const revPts = result.reverse ? result.reverse.voltages.length : 0;

                    const statusEl = document.getElementById('data-file-status');
                    statusEl.textContent = `${file.name} (${fwdPts}/${revPts})`;
                    statusEl.classList.add('loaded');
                    updateCalculateButton();
                    setAnalysisStatus(`Loaded: ${fwdPts} fwd, ${revPts} rev points`, 'success');
                } catch (err) {
                    setAnalysisStatus('Failed to parse: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseIVCSV(content) {
            const lines = content.trim().split('\n');
            const forward = { voltages: [], currents: [] };
            const reverse = { voltages: [], currents: [] };

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.startsWith('#') || line.toLowerCase().startsWith('direction') ||
                    line.toLowerCase().startsWith('voltage')) continue;

                const parts = line.split(',');

                if (parts.length >= 3 && (parts[0] === 'Forward' || parts[0] === 'Reverse')) {
                    // Format: Direction,Voltage,Current
                    const v = parseFloat(parts[1]);
                    const c = parseFloat(parts[2]);
                    if (!isNaN(v) && !isNaN(c)) {
                        if (parts[0] === 'Forward') {
                            forward.voltages.push(v);
                            forward.currents.push(c);
                        } else {
                            reverse.voltages.push(v);
                            reverse.currents.push(c);
                        }
                    }
                } else if (parts.length >= 2) {
                    // Format: Voltage,Current (assume forward only)
                    const v = parseFloat(parts[0]);
                    const c = parseFloat(parts[1]);
                    if (!isNaN(v) && !isNaN(c)) {
                        forward.voltages.push(v);
                        forward.currents.push(c);
                    }
                }
            }

            if (forward.voltages.length === 0 && reverse.voltages.length === 0) {
                throw new Error('No valid data found');
            }

            return {
                forward: forward.voltages.length > 0 ? forward : null,
                reverse: reverse.voltages.length > 0 ? reverse : null
            };
        }

        function updateCalculateButton() {
            const sweepType = document.querySelector('input[name="sweep-select"]:checked').value;
            const hasData = (sweepType === 'forward' && analysisState.forwardData) ||
                           (sweepType === 'reverse' && analysisState.reverseData);
            document.getElementById('calculate-params-btn').disabled = !hasData;
        }

        function setAnalysisStatus(message, type = '') {
            const el = document.getElementById('analysis-status');
            el.textContent = message;
            el.className = 'analysis-status-text';
            if (type) {
                el.classList.add(type);
            }
        }

        function calculateParameters() {
            const sweepType = document.querySelector('input[name="sweep-select"]:checked').value;
            const data = sweepType === 'forward' ? analysisState.forwardData : analysisState.reverseData;

            if (!data) {
                setAnalysisStatus(`No ${sweepType} data loaded`, 'error');
                return;
            }

            try {
                const voltages = data.voltages;
                const currents = data.currents;

                // Sort by voltage for consistent analysis
                const sorted = sortByVoltage(voltages, currents);

                // Calculate parameters
                const isc = interpolateAtX(sorted.v, sorted.i, 0);  // I at V=0
                const voc = findVoc(sorted.v, sorted.i);  // V at I=0

                // Find max power point (power = |V * I|, but we want the quadrant where it generates power)
                let pmax = 0, vmpp = 0, impp = 0;
                for (let j = 0; j < sorted.v.length; j++) {
                    // In photovoltaic convention, power generation is where V > 0 and I < 0
                    const power = sorted.v[j] * sorted.i[j];
                    // For solar cells, maximum power is where V*I is most negative (max generation)
                    if (power < pmax || pmax === 0) {
                        // But we want the absolute power output
                        const absPower = Math.abs(power);
                        if (absPower > Math.abs(pmax)) {
                            pmax = -power;  // Store as positive power output
                            vmpp = sorted.v[j];
                            impp = sorted.i[j];
                        }
                    }
                }

                // Recalculate properly: find where V*I is most negative
                pmax = 0;
                for (let j = 0; j < sorted.v.length; j++) {
                    const power = -sorted.v[j] * sorted.i[j];  // Negative because I is negative when generating
                    if (power > pmax) {
                        pmax = power;
                        vmpp = sorted.v[j];
                        impp = sorted.i[j];
                    }
                }

                // Fill factor
                const ff = (voc > 0 && isc !== 0) ? pmax / (Math.abs(isc) * voc) : 0;

                // Resistances
                const rs = calculateRs(sorted.v, sorted.i, voc);
                const rsh = calculateRsh(sorted.v, sorted.i);

                // Optional: Jsc and PCE if area is provided
                const areaInput = document.getElementById('cell-area').value;
                const area = parseFloat(areaInput);
                let jsc = null, pce = null;
                if (!isNaN(area) && area > 0) {
                    jsc = Math.abs(isc) / area;  // mA/cm²
                    pce = (pmax / (area * 100)) * 100;  // % (assuming 100 mW/cm² AM1.5G)
                }

                // Store metrics
                analysisState.metrics = {
                    voc, isc, pmax, vmpp, impp, ff, rs, rsh, jsc, pce,
                    sweepType,
                    dataPoints: voltages.length
                };

                // Update display
                updateMetricsDisplay();
                updateAnalysisPlot(sorted.v, sorted.i, sweepType, voc, isc, vmpp, impp);
                setAnalysisStatus('Analysis complete', 'success');
                document.getElementById('btn-save-analysis').disabled = false;

            } catch (err) {
                setAnalysisStatus('Calculation error: ' + err.message, 'error');
                console.error(err);
            }
        }

        function sortByVoltage(voltages, currents) {
            const pairs = voltages.map((v, i) => ({ v, i: currents[i] }));
            pairs.sort((a, b) => a.v - b.v);
            return {
                v: pairs.map(p => p.v),
                i: pairs.map(p => p.i)
            };
        }

        function interpolateAtX(xArr, yArr, targetX) {
            // Find the two points bracketing targetX
            for (let i = 0; i < xArr.length - 1; i++) {
                if ((xArr[i] <= targetX && xArr[i + 1] >= targetX) ||
                    (xArr[i] >= targetX && xArr[i + 1] <= targetX)) {
                    const x1 = xArr[i], x2 = xArr[i + 1];
                    const y1 = yArr[i], y2 = yArr[i + 1];
                    return y1 + (targetX - x1) * (y2 - y1) / (x2 - x1);
                }
            }
            // If targetX is outside the range, return the closest value
            if (targetX <= xArr[0]) return yArr[0];
            return yArr[yArr.length - 1];
        }

        function findVoc(voltages, currents) {
            // Find where current crosses zero (from negative to positive or vice versa)
            for (let i = 0; i < currents.length - 1; i++) {
                if ((currents[i] <= 0 && currents[i + 1] >= 0) ||
                    (currents[i] >= 0 && currents[i + 1] <= 0)) {
                    // Linear interpolation
                    const v1 = voltages[i], v2 = voltages[i + 1];
                    const i1 = currents[i], i2 = currents[i + 1];
                    return v1 + (0 - i1) * (v2 - v1) / (i2 - i1);
                }
            }
            // Fallback: find voltage where current is closest to zero
            let minIdx = 0, minAbs = Math.abs(currents[0]);
            for (let i = 1; i < currents.length; i++) {
                if (Math.abs(currents[i]) < minAbs) {
                    minAbs = Math.abs(currents[i]);
                    minIdx = i;
                }
            }
            return voltages[minIdx];
        }

        function calculateRs(voltages, currents, voc) {
            // Series resistance: slope of I-V curve near Voc
            // Find points near Voc (within 0.1V)
            const nearVoc = [];
            for (let i = 0; i < voltages.length; i++) {
                if (Math.abs(voltages[i] - voc) < 0.1) {
                    nearVoc.push({ v: voltages[i], i: currents[i] });
                }
            }
            if (nearVoc.length < 2) return null;

            // Linear regression for dV/dI
            const n = nearVoc.length;
            let sumV = 0, sumI = 0, sumVI = 0, sumI2 = 0;
            for (const p of nearVoc) {
                sumV += p.v;
                sumI += p.i;
                sumVI += p.v * p.i;
                sumI2 += p.i * p.i;
            }
            const denom = n * sumI2 - sumI * sumI;
            if (Math.abs(denom) < 1e-10) return null;
            const slope = (n * sumVI - sumV * sumI) / denom;
            return Math.abs(slope) * 1000;  // Convert to ohms (current is in mA)
        }

        function calculateRsh(voltages, currents) {
            // Shunt resistance: slope of I-V curve near V=0
            const nearZero = [];
            for (let i = 0; i < voltages.length; i++) {
                if (Math.abs(voltages[i]) < 0.1) {
                    nearZero.push({ v: voltages[i], i: currents[i] });
                }
            }
            if (nearZero.length < 2) return null;

            // Linear regression for dV/dI
            const n = nearZero.length;
            let sumV = 0, sumI = 0, sumVI = 0, sumI2 = 0;
            for (const p of nearZero) {
                sumV += p.v;
                sumI += p.i;
                sumVI += p.v * p.i;
                sumI2 += p.i * p.i;
            }
            const denom = n * sumI2 - sumI * sumI;
            if (Math.abs(denom) < 1e-10) return null;
            const slope = (n * sumVI - sumV * sumI) / denom;
            return Math.abs(slope) * 1000;  // Convert to ohms
        }

        function updateMetricsDisplay() {
            const m = analysisState.metrics;
            if (!m) return;

            // PCE - headline metric (only show if area was provided)
            const pceGroup = document.getElementById('pce-metric-group');
            if (m.pce !== null) {
                pceGroup.style.display = '';
                document.getElementById('metric-pce').textContent = m.pce.toFixed(2) + ' %';
            } else {
                pceGroup.style.display = 'none';
            }

            // Jsc/Isc - show both when area provided, just Isc otherwise
            const jscGroup = document.getElementById('jsc-metric-group');
            const iscGroup = document.getElementById('isc-metric-group');
            const jscEl = document.getElementById('metric-jsc');
            const iscEl = document.getElementById('metric-isc');

            if (m.jsc !== null) {
                // Area provided: show both Jsc and Isc
                jscGroup.style.display = '';
                iscGroup.style.display = '';
                jscEl.textContent = m.jsc.toFixed(2) + ' mA/cm²';
                iscEl.textContent = m.isc.toFixed(3) + ' mA';
            } else {
                // No area: show only Isc (hide Jsc)
                jscGroup.style.display = 'none';
                iscGroup.style.display = '';
                iscEl.textContent = m.isc.toFixed(3) + ' mA';
            }

            // Voc, FF, Pmax
            document.getElementById('metric-voc').textContent = m.voc.toFixed(3) + ' V';
            document.getElementById('metric-ff').textContent = (m.ff * 100).toFixed(1) + ' %';
            document.getElementById('metric-pmax').textContent = m.pmax.toFixed(3) + ' mW';

            // MPP values
            document.getElementById('metric-vmpp').textContent = m.vmpp.toFixed(3) + ' V';
            document.getElementById('metric-impp').textContent = m.impp.toFixed(3) + ' mA';

            // Resistances
            document.getElementById('metric-rs').textContent = m.rs !== null ? m.rs.toFixed(1) + ' Ω' : '-- Ω';
            document.getElementById('metric-rsh').textContent = m.rsh !== null ? m.rsh.toFixed(0) + ' Ω' : '-- Ω';
        }

        function updateAnalysisPlot(voltages, currents, sweepType, voc, isc, vmpp, impp) {
            const plotDiv = document.getElementById('iv-analysis-plot');
            const layout = getPlotLayout(LabTheme.isDark());

            // Build traces
            const fwdTrace = {
                x: sweepType === 'forward' ? voltages : [],
                y: sweepType === 'forward' ? currents : [],
                mode: 'lines+markers',
                type: 'scatter',
                name: 'Forward',
                line: { color: '#4A90D9' },
                marker: { size: 6 }
            };
            const revTrace = {
                x: sweepType === 'reverse' ? voltages : [],
                y: sweepType === 'reverse' ? currents : [],
                mode: 'lines+markers',
                type: 'scatter',
                name: 'Reverse',
                line: { color: '#e57373' },
                marker: { size: 6 }
            };

            // Marker traces
            const vocTrace = {
                x: [voc],
                y: [0],
                mode: 'markers',
                type: 'scatter',
                name: `Voc (${voc.toFixed(3)} V)`,
                marker: { color: '#00C853', size: 12, symbol: 'diamond' }
            };
            const iscTrace = {
                x: [0],
                y: [isc],
                mode: 'markers',
                type: 'scatter',
                name: `Isc (${isc.toFixed(3)} mA)`,
                marker: { color: '#FF6D00', size: 12, symbol: 'diamond' }
            };
            const mppTrace = {
                x: [vmpp],
                y: [impp],
                mode: 'markers',
                type: 'scatter',
                name: `MPP (${(vmpp * Math.abs(impp)).toFixed(3)} mW)`,
                marker: { color: '#AA00FF', size: 14, symbol: 'star' }
            };

            Plotly.newPlot(plotDiv, [fwdTrace, revTrace, vocTrace, iscTrace, mppTrace], layout, plotConfig);
        }

        function saveAnalysisResults() {
            const m = analysisState.metrics;
            if (!m) return;

            // Build CSV with metadata header
            let csv = '# I-V Analysis Results\n';
            const now = new Date();
            const timestamp = now.toISOString().replace('T', ' ').split('.')[0];
            csv += `# Generated: ${timestamp}\n`;
            if (analysisState.cellNumber) csv += `# Cell: ${analysisState.cellNumber}\n`;
            if (analysisState.pixel) csv += `# Pixel: ${analysisState.pixel}\n`;
            if (analysisState.sourceFile) csv += `# Source: ${analysisState.sourceFile}\n`;
            csv += `# Sweep: ${m.sweepType}\n`;
            csv += `# Data Points: ${m.dataPoints}\n`;
            csv += '#\n';
            csv += `# Voc: ${m.voc.toFixed(4)} V\n`;
            csv += `# Isc: ${m.isc.toFixed(4)} mA\n`;
            if (m.jsc !== null) csv += `# Jsc: ${m.jsc.toFixed(4)} mA/cm^2\n`;
            csv += `# Fill Factor: ${(m.ff * 100).toFixed(2)} %\n`;
            csv += `# Pmax: ${m.pmax.toFixed(4)} mW\n`;
            if (m.pce !== null) csv += `# PCE: ${m.pce.toFixed(2)} %\n`;
            csv += `# Vmpp: ${m.vmpp.toFixed(4)} V\n`;
            csv += `# Impp: ${m.impp.toFixed(4)} mA\n`;
            if (m.rs !== null) csv += `# Rs: ${m.rs.toFixed(2)} ohms\n`;
            if (m.rsh !== null) csv += `# Rsh: ${m.rsh.toFixed(2)} ohms\n`;
            csv += '#\n';

            // Add data section
            const data = m.sweepType === 'forward' ? analysisState.forwardData : analysisState.reverseData;
            csv += 'Voltage (V),Current (mA)\n';
            for (let i = 0; i < data.voltages.length; i++) {
                csv += `${data.voltages[i].toFixed(4)},${data.currents[i].toFixed(6)}\n`;
            }

            // Save via Python bridge
            const api = LabAPI.get();
            if (api && api.save_analysis_data) {
                api.save_analysis_data(csv, (result) => {
                    const r = JSON.parse(result);
                    if (r.success) {
                        setAnalysisStatus('Results saved to ' + r.path, 'success');
                    } else if (r.message !== 'Cancelled') {
                        setAnalysisStatus('Save failed: ' + r.message, 'error');
                    }
                });
            }
        }

        // Listen for sweep selector changes
        document.querySelectorAll('input[name="sweep-select"]').forEach(radio => {
            radio.addEventListener('change', updateCalculateButton);
        });

        // ============================================
        // Global Exports
        // ============================================

        window.onMeasurementPoint = onMeasurementPoint;
        window.onMeasurementComplete = onMeasurementComplete;
        window.onMeasurementProgress = onMeasurementProgress;
        window.updateDeviceStatus = updateDeviceStatus;
        window.switchTab = switchTab;

        // ============================================
        // Console Panel Functions
        // ============================================

        let consoleVisible = false;
        const consoleMessages = [];
        const MAX_CONSOLE_MESSAGES = 500;

        function toggleConsole() {
            consoleVisible = !consoleVisible;
            const panel = document.getElementById('console-panel');
            panel.classList.toggle('visible', consoleVisible);
        }

        function clearConsole() {
            consoleMessages.length = 0;
            const output = document.getElementById('console-output');
            output.innerHTML = '<div class="console-empty">Console cleared.</div>';
        }

        function addConsoleMessage(level, message) {
            const now = new Date();
            const time = now.toTimeString().split(' ')[0];

            consoleMessages.push({ time, level, message });
            if (consoleMessages.length > MAX_CONSOLE_MESSAGES) {
                consoleMessages.shift();
            }

            renderConsole();
        }

        function renderConsole() {
            const output = document.getElementById('console-output');
            if (consoleMessages.length === 0) {
                output.innerHTML = '<div class="console-empty">No log messages yet.</div>';
                return;
            }

            output.innerHTML = consoleMessages.map(msg => `
                <div class="console-line">
                    <span class="console-time">${msg.time}</span>
                    <span class="console-level ${msg.level}">${msg.level}</span>
                    <span class="console-message">${escapeHtml(msg.message)}</span>
                </div>
            `).join('');

            // Auto-scroll to bottom
            output.scrollTop = output.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Called from Python via WebChannel
        function onLogMessage(level, message) {
            addConsoleMessage(level, message);
        }

        window.onLogMessage = onLogMessage;

        // ============================================
        // Keyboard Shortcuts
        // ============================================

        document.addEventListener('keydown', (e) => {
            // Ctrl+Shift+T - Toggle console panel
            if (e.ctrlKey && e.shiftKey && e.key === 'T') {
                e.preventDefault();
                toggleConsole();
            }
            // Ctrl+Shift+D - Toggle debug mode
            else if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                const api = LabAPI.get();
                if (api && api.toggle_debug_mode) {
                    api.toggle_debug_mode((result) => {
                        const response = JSON.parse(result);
                        if (response.enabled) {
                            addConsoleMessage('info', 'Debug mode ENABLED - verbose output now visible');
                            LabModals.showInfo(
                                'Debug Mode Enabled',
                                'Technical debug output is now visible in the console.\n\nPress Ctrl+Shift+D again to disable.'
                            );
                        } else {
                            addConsoleMessage('info', 'Debug mode DISABLED');
                            LabModals.showInfo('Debug Mode Disabled', 'Technical debug output is now hidden.');
                        }
                    });
                }
            }
            // Ctrl+Shift+E - Toggle analysis panel (staff mode)
            else if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                e.preventDefault();
                toggleAnalysisPanel();
            }
        });
    </script>
</body>
</html>
