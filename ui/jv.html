<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-V Measurement - PHYS 2150</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">

    <!-- Plotly.js for interactive plots (local copy) -->
    <script src="js/plotly.min.js"></script>

    <!-- Qt WebChannel -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <!-- Shared modules -->
    <script src="js/api.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/modals.js"></script>
</head>
<body class="dark-mode">
    <div class="app-container">
        <!-- Controls Panel (Left) -->
        <aside class="controls-panel">
            <!-- Device Status -->
            <div class="controls-section">
                <div class="controls-section-title">Device Status</div>
                <div class="status-indicator" id="device-status">
                    <span class="status-dot disconnected" id="status-dot"></span>
                    <span id="status-text">Connecting...</span>
                </div>
            </div>

            <div class="controls-divider"></div>

            <!-- Measurement Parameters -->
            <div class="controls-section">
                <div class="controls-section-title">Measurement Parameters</div>

                <div class="input-group">
                    <label for="start-voltage">Start (V)</label>
                    <input type="text" id="start-voltage" value="-0.1" autocomplete="off">
                </div>

                <div class="input-group">
                    <label for="stop-voltage">Stop (V)</label>
                    <input type="text" id="stop-voltage" value="0.7" autocomplete="off">
                </div>

                <div class="input-group">
                    <label for="step-voltage">Step (V)</label>
                    <input type="text" id="step-voltage" value="0.02" autocomplete="off">
                </div>

                <div class="input-group">
                    <label for="cell-number">Cell Number</label>
                    <input type="text" id="cell-number" placeholder="e.g. 140" maxlength="3">
                </div>
            </div>

            <div class="controls-divider"></div>

            <!-- Status -->
            <div class="controls-section">
                <div class="controls-section-title">Status</div>
                <div class="status-content">
                    <div class="status-message" id="status-message">Ready</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <span class="progress-percent" id="progress-percent">0%</span>
                    </div>
                </div>
            </div>

            <div class="controls-spacer"></div>

            <!-- Measurement Control -->
            <div class="controls-section">
                <button class="btn btn-primary btn-block" id="measure-btn" onclick="toggleMeasurement()">
                    Start Measurement
                </button>
                <button class="btn btn-secondary btn-block" id="save-btn" onclick="saveData()" disabled>
                    Save Data
                </button>
            </div>
        </aside>

        <!-- Main Content (Right) -->
        <main class="main-content">
            <!-- Header -->
            <div class="main-header">
                <h1 class="main-title">J-V Characterization</h1>
                <div class="header-actions">
                    <span id="pixel-label" class="text-muted">Pixel: --</span>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme (Ctrl+Shift+C)" aria-label="Toggle theme">
                        <svg id="sun-icon" class="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                        <svg id="moon-icon" class="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Plot Area -->
            <div class="plot-container" id="plot-container">
                <div id="jv-plot"></div>
            </div>
        </main>
    </div>

    <!-- Cell Number Modal -->
    <div class="modal-overlay" id="cell-modal">
        <div class="modal">
            <div class="modal-title">Enter Cell Number</div>
            <div class="modal-body">
                <div class="input-group mb-0">
                    <label for="cell-input">Cell Number (e.g., 195)</label>
                    <input type="text" id="cell-input" pattern="[0-9]{3}" maxlength="3" placeholder="000">
                    <span class="input-error" id="cell-input-error">Please enter a 3-digit cell number</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCellModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmCellNumber()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Pixel Selection Modal -->
    <div class="modal-overlay" id="pixel-modal">
        <div class="modal">
            <div class="modal-title">Select Pixel</div>
            <div class="modal-body">
                <div class="input-group mb-0">
                    <label for="pixel-input">Pixel Number (1-9)</label>
                    <input type="number" id="pixel-input" min="1" max="9" value="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePixelModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmPixel()">Start</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal-overlay" id="error-modal">
        <div class="modal">
            <div class="modal-title" id="error-modal-title">Error</div>
            <div class="modal-body">
                <p id="error-modal-message" style="color: var(--text-secondary); white-space: pre-wrap; text-align: left;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="LabModals.closeError()">OK</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * J-V Measurement Application
         */

        // State
        let isMeasuring = false;
        let currentPixel = null;
        let forwardData = { x: [], y: [] };
        let reverseData = { x: [], y: [] };
        let isOfflineMode = false;
        let isDeviceConnected = false;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            LabTheme.init();
            LabModals.init();
            await LabAPI.init();

            // Small delay to ensure Plotly is ready
            setTimeout(() => {
                initPlot();
                checkDeviceStatus();

                // Prompt for cell number on startup
                LabModals.showCell((cellNumber) => {
                    document.getElementById('cell-number').value = cellNumber;
                });
            }, 50);
        });

        /**
         * Initialize Plotly chart
         */
        function initPlot() {
            clearPlot();
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (typeof Plotly !== 'undefined') {
                Plotly.Plots.resize('jv-plot');
            }
        });

        // Handle theme changes
        window.addEventListener('themechange', (e) => {
            const plotDiv = document.getElementById('jv-plot');
            // Only update if plot has been initialized (has data attribute)
            if (typeof Plotly !== 'undefined' && plotDiv && plotDiv.data) {
                updatePlotTheme(e.detail.dark);
            }
        });

        function getPlotLayout(isDark) {
            const colors = {
                text: isDark ? '#eeeeee' : '#1a1a1a',
                grid: isDark ? '#444444' : '#dddddd',
                zeroline: isDark ? '#666666' : '#999999',
                legendBg: isDark ? 'rgba(50,50,50,0.9)' : 'rgba(255,255,255,0.9)'
            };
            return {
                xaxis: {
                    title: 'Voltage (V)',
                    color: colors.text,
                    gridcolor: colors.grid,
                    zerolinecolor: colors.zeroline,
                    zerolinewidth: 1
                },
                yaxis: {
                    title: 'Current (mA)',
                    color: colors.text,
                    gridcolor: colors.grid,
                    zerolinecolor: colors.zeroline,
                    zerolinewidth: 1
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: colors.text },
                legend: { font: { color: colors.text }, bgcolor: colors.legendBg },
                margin: { t: 20, r: 30, b: 95, l: 60 }
            };
        }

        // Plotly config - always show modebar
        const plotConfig = {
            displayModeBar: true,
            modeBarButtonsToRemove: ['lasso2d', 'select2d', 'toImage'],
            displaylogo: false
        };

        function updatePlotTheme(isDark) {
            const colors = {
                text: isDark ? '#eeeeee' : '#1a1a1a',
                grid: isDark ? '#444444' : '#dddddd',
                zeroline: isDark ? '#666666' : '#999999',
                legendBg: isDark ? 'rgba(50,50,50,0.9)' : 'rgba(255,255,255,0.9)'
            };
            // Use dot notation for reliable relayout updates
            Plotly.relayout('jv-plot', {
                'xaxis.color': colors.text,
                'xaxis.gridcolor': colors.grid,
                'xaxis.zerolinecolor': colors.zeroline,
                'yaxis.color': colors.text,
                'yaxis.gridcolor': colors.grid,
                'yaxis.zerolinecolor': colors.zeroline,
                'font.color': colors.text,
                'legend.font.color': colors.text,
                'legend.bgcolor': colors.legendBg
            });
        }

        /**
         * Check device connection status
         */
        async function checkDeviceStatus() {
            try {
                const api = LabAPI.get();
                if (api && api.get_device_status) {
                    api.get_device_status((result) => {
                        const status = JSON.parse(result);
                        isOfflineMode = status.offline_mode;
                        isDeviceConnected = status.connected;
                        updateDeviceStatus(status.connected, status.message, status.offline_mode);
                    });
                } else {
                    // Fallback - assume offline mode for development
                    isOfflineMode = true;
                    isDeviceConnected = false;
                    updateDeviceStatus(false, 'Development mode', true);
                }
            } catch (error) {
                updateDeviceStatus(false, 'Connection failed', false);
            }
        }

        function updateDeviceStatus(connected, message, offlineMode) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const btn = document.getElementById('measure-btn');

            isDeviceConnected = connected;
            isOfflineMode = offlineMode;

            if (connected) {
                dot.className = 'status-dot connected';
                text.textContent = message || 'Connected';
                btn.disabled = false;
            } else if (offlineMode) {
                dot.className = 'status-dot warning';
                text.textContent = message || 'Offline mode';
                btn.disabled = false;
            } else {
                dot.className = 'status-dot disconnected';
                text.textContent = message || 'Not connected';
                btn.disabled = true;
            }
        }

        /**
         * Measurement control
         */
        function toggleMeasurement() {
            if (isMeasuring) {
                stopMeasurement();
            } else {
                // Check cell number first
                const cellNumber = document.getElementById('cell-number').value;
                if (!cellNumber || !/^\d{3}$/.test(cellNumber)) {
                    LabModals.showCell((cell) => {
                        document.getElementById('cell-number').value = cell;
                        LabModals.showPixel(startMeasurement);
                    });
                    return;
                }
                LabModals.showPixel(startMeasurement);
            }
        }

        async function startMeasurement(pixel) {
            currentPixel = pixel;
            isMeasuring = true;
            updateMeasuringState(true);
            updateProgress(0, 'Starting forward sweep...');

            // Clear previous data and disable save
            forwardData = { x: [], y: [] };
            reverseData = { x: [], y: [] };
            document.getElementById('save-btn').disabled = true;
            clearPlot();
            updatePixelLabel(pixel);

            // Get parameters
            const params = {
                start_voltage: parseFloat(document.getElementById('start-voltage').value),
                stop_voltage: parseFloat(document.getElementById('stop-voltage').value),
                step_voltage: parseFloat(document.getElementById('step-voltage').value),
                cell_number: document.getElementById('cell-number').value,
                pixel: pixel
            };

            if (isDeviceConnected) {
                // Use real hardware via Python API
                console.log('Starting hardware measurement with params:', params);
                const api = LabAPI.get();
                if (api && api.start_measurement) {
                    api.start_measurement(JSON.stringify(params), (result) => {
                        const response = JSON.parse(result);
                        if (!response.success) {
                            LabModals.showError('Measurement Failed', response.message);
                            isMeasuring = false;
                            updateMeasuringState(false);
                        }
                    });
                }
            } else if (isOfflineMode) {
                // Run mock measurement in offline mode
                console.log('Starting mock measurement with params:', params);
                mockMeasurement(params);
            } else {
                LabModals.showError('No Device', 'No device connected. Use --offline flag for testing.');
                isMeasuring = false;
                updateMeasuringState(false);
            }
        }

        function stopMeasurement() {
            isMeasuring = false;
            updateMeasuringState(false);
            updateProgress(0, 'Stopped');

            const api = LabAPI.get();
            if (api && api.stop_measurement) {
                api.stop_measurement(() => {});
            }
        }

        function updateMeasuringState(measuring) {
            const btn = document.getElementById('measure-btn');
            const inputs = document.querySelectorAll('.controls-panel input');

            if (measuring) {
                btn.textContent = 'Stop Measurement';
                btn.className = 'btn btn-danger btn-block';
                inputs.forEach(input => input.disabled = true);
            } else {
                btn.textContent = 'Start Measurement';
                btn.className = 'btn btn-primary btn-block';
                inputs.forEach(input => input.disabled = false);
            }
        }

        function updateProgress(percent, message) {
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-percent').textContent = Math.round(percent) + '%';
            if (message) {
                document.getElementById('status-message').textContent = message;
            }
        }

        function updatePixelLabel(pixel) {
            document.getElementById('pixel-label').textContent = `Pixel: ${pixel}`;
        }

        /**
         * Plot updates - called from Python via WebChannel
         */
        function onMeasurementPoint(direction, voltage, current) {
            if (direction === 'forward') {
                forwardData.x.push(voltage);
                forwardData.y.push(current);
            } else {
                reverseData.x.push(voltage);
                reverseData.y.push(current);
            }
            updatePlot();
        }

        function onMeasurementComplete(success) {
            isMeasuring = false;
            updateMeasuringState(false);

            if (success) {
                updateProgress(100, 'Complete');
                // Enable save button and prompt to save immediately
                document.getElementById('save-btn').disabled = false;
                console.log('Measurement complete');
                saveData();
            } else {
                updateProgress(0, 'Failed');
            }
        }

        /**
         * Save measurement data to CSV via Python API
         */
        function saveData() {
            const cellNumber = document.getElementById('cell-number').value || '000';
            const pixel = currentPixel || 1;

            // Generate CSV content
            let csv = 'Direction,Voltage (V),Current (mA)\n';

            // Add forward sweep data
            for (let i = 0; i < forwardData.x.length; i++) {
                csv += `Forward,${forwardData.x[i].toFixed(4)},${forwardData.y[i].toFixed(6)}\n`;
            }

            // Add reverse sweep data
            for (let i = 0; i < reverseData.x.length; i++) {
                csv += `Reverse,${reverseData.x[i].toFixed(4)},${reverseData.y[i].toFixed(6)}\n`;
            }

            // Call Python API to save (shows native file dialog)
            const api = LabAPI.get();
            if (api && api.save_csv_data) {
                api.save_csv_data(csv, cellNumber, pixel, (result) => {
                    const response = JSON.parse(result);
                    if (response.success) {
                        console.log('Data saved to:', response.path);
                    } else if (response.message !== 'Cancelled') {
                        LabModals.showError('Save Failed', response.message);
                    }
                });
            } else {
                console.error('Save API not available');
            }
        }

        function clearPlot() {
            const plotDiv = document.getElementById('jv-plot');
            const layout = getPlotLayout(LabTheme.isDark());
            const traces = [
                { x: [], y: [], mode: 'markers', type: 'scatter', name: 'Forward', marker: { color: '#4A90D9', size: 8 } },
                { x: [], y: [], mode: 'markers', type: 'scatter', name: 'Reverse', marker: { color: '#e57373', size: 8 } }
            ];
            Plotly.newPlot(plotDiv, traces, layout, plotConfig);
        }

        function updatePlot() {
            const plotDiv = document.getElementById('jv-plot');
            const layout = getPlotLayout(LabTheme.isDark());
            const traces = [
                { x: forwardData.x, y: forwardData.y, mode: 'markers', type: 'scatter', name: 'Forward', marker: { color: '#4A90D9', size: 8 } },
                { x: reverseData.x, y: reverseData.y, mode: 'markers', type: 'scatter', name: 'Reverse', marker: { color: '#e57373', size: 8 } }
            ];
            Plotly.newPlot(plotDiv, traces, layout, plotConfig);
        }

        /**
         * Mock measurement for development/testing
         */
        function mockMeasurement(params) {
            const start = params.start_voltage;
            const stop = params.stop_voltage;
            const step = params.step_voltage;
            const totalSteps = Math.ceil((stop - start) / step);
            let stepCount = 0;

            let voltage = start;
            const interval = setInterval(() => {
                if (!isMeasuring || voltage > stop) {
                    clearInterval(interval);
                    // Reverse sweep
                    if (isMeasuring) {
                        updateProgress(50, 'Reverse sweep...');
                        mockReverseSweep(stop, start, step, totalSteps);
                    }
                    return;
                }

                // Mock current (simple diode model)
                const current = 0.01 * (Math.exp(voltage / 0.026) - 1) + (Math.random() - 0.5) * 0.001;
                onMeasurementPoint('forward', voltage, current * 1000);
                stepCount++;
                const progress = (stepCount / totalSteps) * 50; // Forward is 0-50%
                updateProgress(progress, `Forward: ${voltage.toFixed(2)} V`);
                voltage += step;
            }, 50);
        }

        function mockReverseSweep(start, stop, step, totalSteps) {
            let stepCount = 0;
            let voltage = start;
            const interval = setInterval(() => {
                if (!isMeasuring || voltage < stop) {
                    clearInterval(interval);
                    onMeasurementComplete(true);
                    return;
                }

                const current = 0.01 * (Math.exp(voltage / 0.026) - 1) + (Math.random() - 0.5) * 0.001;
                onMeasurementPoint('reverse', voltage, current * 1000);
                stepCount++;
                const progress = 50 + (stepCount / totalSteps) * 50; // Reverse is 50-100%
                updateProgress(progress, `Reverse: ${voltage.toFixed(2)} V`);
                voltage -= step;
            }, 50);
        }

        // Called by Python to update progress during measurement
        function onMeasurementProgress(percent, message) {
            updateProgress(percent, message);
        }

        // Make functions available to Python
        window.onMeasurementPoint = onMeasurementPoint;
        window.onMeasurementComplete = onMeasurementComplete;
        window.onMeasurementProgress = onMeasurementProgress;
        window.updateDeviceStatus = updateDeviceStatus;
    </script>
</body>
</html>
